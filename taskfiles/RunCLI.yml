version: '3'

tasks:
  extract:
    desc: Extract or Scrape Data
    vars:
      MAX: '{{.MAX | default ""}}'
    preconditions:
      - sh: |
          if [ -z "{{.MAX}}" ]; then
            echo "Error: --max must be set when RUN_MODE is 'extract'"
            exit 1
          fi
    cmds:
      - echo "üîç Starting data extraction..."
      - python run_scraper.py --run_group {{.RUN_GROUP}} --run_name {{.RUN_NAME}} --max {{.MAX}} --run_mode "extract"

  transform:
    desc: Transform Extracted or Scraped Data
    vars:
      LIMIT_VALUES: '{{.LIMIT_VALUES | default ""}}'
    cmds:
      - echo "üîÑ Starting data transformation..."
      - |
        python run_scraper.py \
          --run_group {{.RUN_GROUP}} \
          --run_name {{.RUN_NAME}} \
          --run_mode "transform" {{if .LIMIT_VALUES}} --limit_records {{.LIMIT_VALUES}} {{end}}

  load:
    desc: Load Transformed Data into Filesystem or Postgres DB
    vars:
      DESTINATION: '{{.DESTINATION | default ""}}'
    preconditions:
      - sh: |
          if [ -z "{{.DESTINATION}}" ]; then
            echo "Error: --destination must be set when RUN_MODE is 'load'"
            exit 1
          fi
    cmds:
      - echo "üì§ Loading data to destination..."
      - python run_scraper.py --run_group {{.RUN_GROUP}} --run_name {{.RUN_NAME}} --destination {{.DESTINATION}} --run_mode "load"

  run-jobs:
    desc: Run the Full ETL Pipeline via CLI
    cmds:
      - task: extract
      - task: transform
      - task: load
      - |
          echo "‚úÖ All ETL steps completed successfully."
